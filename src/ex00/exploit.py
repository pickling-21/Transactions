# cd ex00
# cd materials && python3 -m http.server


from bs4 import BeautifulSoup
import requests


def change_title(soup):
    title = soup.title
    title.string = "Evil Corp - Stealing your money every day"


def hack_name(soup):
    tag_name = soup.find("span", "name")
    pronoun = tag_name.find("span", "pronoun").get_text()
    name_parts = tag_name.get_text().split(' ')
    name = name_parts[-1]

    new_name = soup.new_tag("h1")
    new_name['class'] = "name"
    new_pronoun = soup.new_tag("span")
    new_pronoun['class'] = "pronoun"
    new_pronoun.insert(1, pronoun)
    new_name.append(new_pronoun)
    new_name.insert(2, name)
    new_name.insert(3, ", you are hacked!")

    soup.body.insert(1, new_name)


def script_penetration(soup):
    script = soup.new_tag("script")
    script.string = '''
        hacked = function() {
            alert('hacked');
        }
        window.addEventListener('load', 
          function() { 
            var f = document.querySelector("form");
            f.setAttribute("onsubmit", "hacked()");
          },
          false
        );
    '''
    soup.body.append(script)


def change_link(soup):
    link = soup.find("a")
    link.string = 'Fsociety'
    link['href'] = "https://mrrobot.fandom.com/wiki/Fsociety"


if __name__ == "__main__":
    url = 'http://127.0.0.1:8000/evilcorp.html'
    page = requests.get(url)
    soup = BeautifulSoup(page.text, 'html.parser')

    change_title(soup)
    hack_name(soup)
    script_penetration(soup)
    change_link(soup)

    with open("../../materials/evilcorp_hacked.html", "w") as file:
        file.write(str(soup))
